From 8c0a4b6679f4b056693f12e1b37162f2a7ea5ef3 Mon Sep 17 00:00:00 2001
From: Stefan Sayer <stefan.sayer@googlemail.com>
Date: Tue, 17 Apr 2012 15:41:56 +0200
Subject: [PATCH] DSM:mod_dlg: added setting errno if dlg.acceptInvite fails

---
 apps/dsm/mods/mod_dlg/ModDlg.cpp |    3 +++
 apps/dsm/mods/mod_dlg/ModDlg.h   |    2 ++
 doc/dsm/mods/Readme.mod_dlg.txt  |    2 +-
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/apps/dsm/mods/mod_dlg/ModDlg.cpp b/apps/dsm/mods/mod_dlg/ModDlg.cpp
index 3c97285..b470f88 100644
--- a/apps/dsm/mods/mod_dlg/ModDlg.cpp
+++ b/apps/dsm/mods/mod_dlg/ModDlg.cpp
@@ -170,6 +170,9 @@ EXEC_ACTION_START(DLGAcceptInviteAction) {
     ERROR("%i %s\n",e.code,e.reason.c_str());
     sess->setStopped();
     sess->dlg.reply(*sc_sess->last_req.get(),e.code,e.reason);
+
+    sc_sess->SET_ERRNO(DSM_ERRNO_DLG);
+    sc_sess->SET_STRERROR("Error accepting call: "+ int2str(e.code) + " "+ e.reason);
   }
 } EXEC_ACTION_END;
 
diff --git a/apps/dsm/mods/mod_dlg/ModDlg.h b/apps/dsm/mods/mod_dlg/ModDlg.h
index 978288b..a8535d6 100644
--- a/apps/dsm/mods/mod_dlg/ModDlg.h
+++ b/apps/dsm/mods/mod_dlg/ModDlg.h
@@ -30,6 +30,8 @@
 
 #define MOD_CLS_NAME DLGModule 
 
+#define DSM_ERRNO_DLG "dlg"
+
 DECLARE_MODULE_BEGIN(MOD_CLS_NAME);
 bool onInvite(const AmSipRequest& req, DSMSession* sess);
 DECLARE_MODULE_END;
diff --git a/doc/dsm/mods/Readme.mod_dlg.txt b/doc/dsm/mods/Readme.mod_dlg.txt
index 569cfe5..33d2208 100644
--- a/doc/dsm/mods/Readme.mod_dlg.txt
+++ b/doc/dsm/mods/Readme.mod_dlg.txt
@@ -30,7 +30,7 @@ dlg.acceptInvite([code, reason]);
  * sets $errno (arg,general)
  
  accept audio stream from last_req (INVITE), and reply with 200 OK (default)
- or code, reason
+ or code, reason. sets "dlg" type errno if negotiation fails.
  
 dlg.bye([headers])
  send BYE. useful for example for continuing processing after call has ended.
-- 
1.7.10.4

